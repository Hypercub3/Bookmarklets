javascript:(function(){var count=0,text;const selection=window.getSelection();const originalRange=selection.rangeCount>0?selection.getRangeAt(0).cloneRange():null;text=selection.toString().trim();if(text==null||text.length==0){text=prompt("Search phrase:","");if(text==null||text.length==0)return;}const lightBgHighlights=['#FFCCBC','#FFCC80','#E6EE9C','#DCEDC8','#C8E6C9','#B2DFDB','#B2EBF2','#B3E5FC','#E1BEE7','#F8BBD0'];const darkBgHighlights=['#F4511E','#EF6C00','#827717','#558B2F','#1B5E20','#00796B','#00838F','#01579B','#512DA8','#AD1457'];function isDarkBackground(element){try{let bgColor=window.getComputedStyle(element).backgroundColor;let currentElement=element;while((bgColor==='transparent'||bgColor==='rgba(0, 0, 0, 0)')&&currentElement.parentElement&&currentElement.tagName!=='HTML'){currentElement=currentElement.parentElement;bgColor=window.getComputedStyle(currentElement).backgroundColor;}if(bgColor==='transparent'||bgColor==='rgba(0, 0, 0, 0)'||!bgColor)return false;const rgb=bgColor.match(/\d+/g);if(!rgb)return false;const brightness=(parseInt(rgb[0])*299+parseInt(rgb[1])*587+parseInt(rgb[2])*114)/1000;return brightness<128;}catch(e){console.error('Error in background detection:',e);return false;}}let selectedNode=selection.anchorNode;const isDark=isDarkBackground(selectedNode?selectedNode.parentElement:document.body);const highlights=isDark?darkBgHighlights:lightBgHighlights;const existingHighlights=document.querySelectorAll(`span[data-highlight-term="${text}"]`);existingHighlights.forEach(highlight=>{const parent=highlight.parentNode;const textNode=document.createTextNode(highlight.textContent);parent.replaceChild(textNode,highlight);parent.normalize();});const currentHighlights=document.querySelectorAll('span[data-highlight-term]');const activeColors=new Set();currentHighlights.forEach(highlight=>{if(highlight.getAttribute('data-highlight-term')!==text){activeColors.add(highlight.style.backgroundColor);}});function rgbToHex(rgb){try{if(rgb.startsWith('#'))return rgb;const values=rgb.match(/\d+/g);if(!values)return '#000000';return '#'+values.map(x=>{const hex=parseInt(x).toString(16);return hex.length===1?'0'+hex:hex;}).join('');}catch(e){return '#000000';}}const usedColors=Array.from(activeColors).map(rgbToHex);const availableColors=highlights.filter(color=>!usedColors.includes(color));const highlightColor=availableColors.length>0?availableColors[Math.floor(Math.random()*availableColors.length)]:highlights[Math.floor(Math.random()*highlights.length)];function getTextColor(bgColor){try{const hex=bgColor.replace('#','');const r=parseInt(hex.substr(0,2),16);const g=parseInt(hex.substr(2,2),16);const b=parseInt(hex.substr(4,2),16);const brightness=(r*299+g*587+b*114)/1000;return brightness>128?'#000000':'#FFFFFF';}catch(e){return isDark?'#FFFFFF':'#000000';}}function searchWithinNode(node,searchText,len,color){try{if(!node||!node.textContent||node.textContent.trim()===''){return 0;}var pos,skip=0;if(node.nodeType===3){const nodeText=node.data.toUpperCase();searchText=searchText.toUpperCase();pos=nodeText.indexOf(searchText);if(pos>=0){const spannode=document.createElement("SPAN");spannode.style.backgroundColor=color;spannode.style.color=getTextColor(color);spannode.setAttribute('data-highlight-term',text);const middlebit=node.splitText(pos);const endbit=middlebit.splitText(len);const middleclone=middlebit.cloneNode(true);spannode.appendChild(middleclone);middlebit.parentNode.replaceChild(spannode,middlebit);count++;skip=1;}}else if(node.nodeType===1&&node.childNodes&&!/(script|style|textarea)/i.test(node.tagName)){for(var i=0;i<node.childNodes.length;i++){i+=searchWithinNode(node.childNodes[i],searchText,len,color);}}return skip;}catch(e){console.error('Error in searchWithinNode:',e);return 0;}}window.status="Searching for '"+text+"'...";searchWithinNode(document.body,text,text.length,highlightColor);window.status="Found "+count+" occurrence"+(count==1?"":"s")+" of '"+text+"'.";if(originalRange){selection.removeAllRanges();selection.addRange(originalRange);}})();
